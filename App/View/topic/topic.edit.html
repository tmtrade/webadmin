<? require(ViewDir.'/header.html');?>
<link rel="stylesheet" href="<?=StaticDir?>1.2/css/details.css">
<link rel="stylesheet" href="<?=StaticDir?>1.2/css/import.css" />

<style>
.img-flip {
        position:absolute;
        width:16px;
        height:16px;
        -webkit-transform:rotate(180deg);
        -moz-transform:rotate(180deg);
        -ms-transform:rotate(180deg);
        transform:rotate(180deg);
    }
</style>
<div class="wrap">
<form id="moduleclass" >
	<input type="hidden" name="moduleId" id="moduleId" value="<?=$module['id']?>">
    <div class="wrap-top">
        <h4>专题设置 》 创建专题</h4><span></span>
    </div>
	<div class="mj-ztBar f-clearfix">
        <span class="mj-ztBr">
            <a class="btn btn-info" href="<?=$referr?>">返回</a>
        </span>
		<div>
			<ul>
				<li>
				<p style="margin:20px 0;padding:0 5px 0 5px;background-color:#FFFF99;border:1px solid #dadada;width:700px;">您可以在此管理首页推荐的商品模块，并为每个模块添加分类和商品。建议每个模块至少有两个分类。</p>
				</li>
				<li>
					<label>专题标题：</label>
					<input type="text" name="name" id="modulename" value="<?=$module['name']?>" maxlength="8" />
					<p style="margin:20px 0;padding:0 5px 0 5px;background-color:#FFFF99;border:1px solid #dadada;width:260px;">模块标题最多不可超过8个中文字符。</p>
				</li>
				<li>
					<label>专题图片：</label>
					<p><img src="<?if($pic['pic']){echo $pic['pic'];}else{echo StaticDir."1.2/images/ztpic.png";}?>" id="showpic" width="355px" height="100px" /></p>
					<p>
						<div class="ztlist">
							<input type="file" id="tjfile" name="fileName" style="display: inline-block;"/>
						</div>
						<em  class="cFF6701" id="tipshow">注：图片建议尺寸为560X155，文件最大不超过200KB，当前支持PG,PNG,BMP,GIF格式文件</em>
					</p>
				</li>
				<li><br><hr><br></li>
				<li>
					<label>banner图：</label>
					<p><img src="<?if($pic['pic']){echo $pic['pic'];}else{echo StaticDir."1.2/images/ztbanner.png";}?>" id="showpic" width="930px" height="130px" /></p>
					<p>
						<div class="ztbanner">
							<input type="file" id="tjfile" name="fileName" style="display: inline-block;"/>
						</div>
						<em  class="cFF6701" id="tipshow">注： 广告图片建议尺寸为 ( 1920 ) x ( 864 )，文件最大不超过200kb，当前支持jpg,bmp,png格式文件</em>
					</p>
				</li>
				<li><br><hr><br></li>
				<li>
					<label>背景设置：</label>
					<input type="text" name="bgColor" id="bgColor" value="<?=$module['name']?>" maxlength="8" /><a href="javascript:void(0);"  class="btn btn-default" id="cp5" >选色</a>
					<p style="margin:20px 0;padding:0 5px 0 5px;">请输入色码或选择颜色</p>
				</li>
				<li><br><hr><br></li>
				<li>
					<label>背景图片：</label>
					<p><img src="<?if($pic['pic']){echo $pic['pic'];}else{echo StaticDir."1.2/images/ztbanner.png";}?>" id="showpic" width="930px" height="130px" /></p>
					<p>
						<div class="ztbanner">
							<input type="file" id="tjfile" name="fileName" style="display: inline-block;"/>
						</div>
						<em  class="cFF6701" id="tipshow">注： 广告图片建议尺寸为 ( 1920 ) x ( 864 )，文件最大不超过200kb，当前支持jpg,bmp,png格式文件</em>
					</p>
				</li>
			</ul>
		</div>
		<hr>    
		<hr>
		<div class="mj-sellT">
			<p>对应商品</p>
			<table>
				<tbody>
				<tr>
					<td>商品名称</td>
					<td>商标号</td>
					<td>操作</td>
				</tr>
				<?foreach ($topicItems['rows'] as $ky => $vl) { ?>
				<input type='hidden' value='<?=$vl['number']?>===<?=$vl['name']?>' name='numbers[]' id="item-<?=$ky?>" >
				<tr>
					<td><?=$vl['name']?></td>
					<td><?=$vl['number']?></td>
					<td>
						<a href="javascript:void(0);" onclick="delClassItem(<?=$ky?>)">删除</a>
						<a href="javascript:void(0);" onclick="editClassItem(<?=$vl['number']?>,<?=$ky?>);">编辑</a>	&nbsp;&nbsp;|&nbsp;&nbsp;
						<span onclick="sortChaneg(<?=$v['id']?>, 2, 1)"><img class="img" src="<?=StaticDir?>1.2/images/u85.gif"></span>&nbsp;&nbsp;
						<span class="img-flip" onclick="sortChaneg(<?=$v['id']?>, 2, 2)"><img class="img" src="<?=StaticDir?>1.2/images/u85.gif"></span>
					</td>
				</tr>
				<?}?>
				</tbody>
			</table>
			<table class="importable">
				<tr id="newclassitem" style="display:none;">
					<input type="hidden" id="sbclassitem" />
					<td><input type="text" id="sbnumber" maxlength="20"  class="inputbig" placeholder="请输入商标号" /></td>
					<td><em id="tradetip"></em></td>
					<td><a href="javascript:void(0)" class="nextanext" id="addsb">确定</a><a href="javascript:void(0)" class="cancelanext" id="cancelaclassitem">取消</a></td>
				</tr>
			</table>
			<br>
			<a href="javascript:void(0)" class="nexta" id="addclassitem">+ 新增商品</a>
			<br>
			<div class="thistip" ><em  class="cFF6701" >每条分类最多可添加8条展示商品</em></div>
			<br>
		</div>
		<div class="mj-deiBlist">
			<div class="mj-deiBtns">
				<?if($moduleLink['total'] < 8 ){?>
				<a href="javascript:void(0);" id="addlink">新增推广链接</a>
				<?}?>
			</div>
		</div>
	</div>


<script type="text/javascript">
    $(function(){
		//添加商品界面显示
		$('#addclassitem').click(function(){
			if(!$('#newclassitem').is(':visible')){
				$('#newclassitem').show();
			}else{
				$('#newclassitem').hide();
			}
		})
		
		//取消添加
		$('#cancelaclassitem').click(function(){
			$('#newclassitem').hide();	
		})
		//添加商标
		$('#addsb').click(function(){
			var number = $('#sbnumber').val();
			if(!number || number == '请输入商标号'){
				$('#tradetip').html('请输入商标号');
				return false;
			}
			$('#tradetip').hide();
			
			var ClassItemNum = $('.ClassItem').length;
			$.ajax({
				type : 'post',
				url  : '/module/gettrade/',
				data : {number:number},
				dataType : 'json',
				success : function (data){
					if (data.code==1){
						
						$('#sbnumber').val('');
						var itemId = $('#sbclassitem').val();
						if(itemId !== ''){
							$('#ClassItem-'+itemId).find('.ClassItemName').html(data.name);
							$('#ClassItem-'+itemId).find('.ClassItemNumber').html(number);
							$('#item-'+itemId).val(number+"==="+data.name);
						}else{
							var str="<tr><td class=\"ClassItemName\" >"+data.name+"</td><td class=\"ClassItemNumber\" >"+number+"</td><td>";
							str += "<a href=\"javascript:void(0);\" onclick=\"delPic("+ClassItemNum+")\">删除</a><a href=\"javascript:void(0);\" onclick=\"setPic();\">编辑</a>	&nbsp;&nbsp;|&nbsp;&nbsp;";
							str += "<a href=\"javascript:void(0);\" onclick=\"delPic("+data.id+")\">删除</a><a href=\"javascript:void(0);\" onclick=\"setPic();\">编辑</a> |";
							str += "</td></tr>";
							$('#classItems').append(str);
							var inputs = "<input type='hidden' value='"+number+"==="+data.name+"' name='numbers[]' id='item-"+ClassItemNum+"' >";
							$('#moduleclass').append(inputs);
						}
						$('#sbclassitem').val('');
						
					}else{
						$('#tradetip').html('错误。无该商标信息，请验证后输入');
					}
				},
				error : function (data){
					layer.msg('操作失败，请稍后重试。', {
						time: 2000 //2秒关闭（如果不配置，默认是3秒）
					});
				}
			});
		})
		
		//添加分类数据
		$('#adddata').click(function(){
			var classname = $('#classname').val();
			if(!classname){
				layer.msg('请填写分类名称', {
					time: 2000 //2秒关闭（如果不配置，默认是3秒）
				});
				return false;
			}
			var data = $("#moduleclass").serialize();
			$.ajax({
				type : 'post',
				url  : '/module/setClass/',
				data : data,
				dataType : 'json',
				success : function (data){
					if (data.code==1){
						layer.msg('操作成功！', {
							time: 1000 //2秒关闭（如果不配置，默认是3秒）
						}, function(){
							parent.window.location.reload();
						});
					}else{
						layer.msg(data.msg, {
							time: 1000 //2秒关闭（如果不配置，默认是3秒）
						});
					}
				},
				error : function (data){
					layer.msg('操作失败，请稍后重试。', {
						time: 2000 //2秒关闭（如果不配置，默认是3秒）
					});
				}
			});
		})
		
		$(".tjform").wrap("<form id='tjformupload' action='/module/ajaxUploadPic/' method='post' enctype='multipart/form-data'></form>");
        $("#tjfile").on('change', function(){
            $("#tjformupload").ajaxSubmit({
                dataType:  'json',
                success: function(data) {
                    if (data.code == 1){
                        $('#pic').val(data.img);
                        $('#showpic').attr('src', data.img);
                    }else{
                        alert(data.msg);
                    }
                },
                error:function(xhr){
                    alert('图片格式不正确或图片过大，请重新上传！');
                }
            });
        });
	})
	
	//编辑显示框
	function editClassItem(number,itemId){
		$('#sbclassitem').val(itemId);
		$('#sbnumber').val(number);
		$('#newclassitem').show();
	}
	
	//删除
	function delClassItem(itemId)
    {
		$('#ClassItem-'+itemId).remove();
		$('#item-'+itemId).remove();
    }
</script>
<script type="text/javascript" src="<?=StaticDir?>1.2/js/jquery.js"></script> 
<script type="text/javascript" src="<?=StaticDir?>1.2/js/jquery.colorpicker.js"></script> 
<script type="text/javascript">
    $(function(){
		var moduleId = $('#moduleId').val();
		/**新增推广链接**/
		$('#addlink').click(function(){
			setLink(moduleId,0);
		})
		/**新增广告图**/
		$('#addpic').click(function(){
			setPic(moduleId,0);
		})			
		
		/**新增分类**/
		$('#addclass').click(function(){
			setClass(moduleId,0);
		})
		
		$("#cp5").colorpicker({
            fillcolor:true,
            event:'mouseover',
            target:$("#bgColor")
        });
    })
</script>
<? require(ViewDir.'/footer.html'); ?>

